<!DOCTYPE html>
<html>
<head>
    <title>Tour VR com Controle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
    <style>
        .button-overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
        }
        #status {
            color: #333;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="button-overlay">
        <div id="status">Status do Controle: Desconectado</div>
    </div>

    <script>
        // Variáveis globais
        let activeGamepad = null;
        const moveSpeed = 0.15;
        let isMoving = false;

        // Componente personalizado para controles
        AFRAME.registerComponent('gamepad-controls', {
            init: function() {
                this.camera = this.el.querySelector('[camera]');
                this.moveVector = new THREE.Vector3();
                
                // Monitora conexão de gamepads
                window.addEventListener('gamepadconnected', (e) => {
                    console.log('Gamepad conectado:', e.gamepad.id);
                    activeGamepad = e.gamepad;
                    document.getElementById('status').textContent = 
                        'Status do Controle: Conectado - ' + e.gamepad.id;
                });

                window.addEventListener('gamepaddisconnected', (e) => {
                    console.log('Gamepad desconectado:', e.gamepad.id);
                    activeGamepad = null;
                    document.getElementById('status').textContent = 
                        'Status do Controle: Desconectado';
                });

                // Suporte a toque para movimento
                const scene = document.querySelector('a-scene');
                scene.addEventListener('touchstart', () => { isMoving = true; });
                scene.addEventListener('touchend', () => { isMoving = false; });
            },

            tick: function() {
                // Atualiza estado do gamepad
                const gamepads = navigator.getGamepads();
                if (activeGamepad) {
                    activeGamepad = gamepads[activeGamepad.index];
                }

                if (!this.camera) return;

                // Movimento por gamepad
                if (activeGamepad) {
                    // Botões comuns do VR Box 2.0
                    const moveForward = activeGamepad.buttons[0].pressed; // Botão principal
                    const moveBackward = activeGamepad.buttons[1].pressed; // Botão secundário
                    const turnLeft = activeGamepad.buttons[2].pressed; // Botão esquerdo
                    const turnRight = activeGamepad.buttons[3].pressed; // Botão direito

                    // Movimento para frente/trás
                    if (moveForward || isMoving) {
                        this.moveVector.set(0, 0, -moveSpeed);
                        this.el.object3D.localToWorld(this.moveVector);
                        this.el.object3D.position.add(this.moveVector);
                    }
                    if (moveBackward) {
                        this.moveVector.set(0, 0, moveSpeed);
                        this.el.object3D.localToWorld(this.moveVector);
                        this.el.object3D.position.add(this.moveVector);
                    }

                    // Rotação
                    if (turnLeft) {
                        this.el.object3D.rotation.y += 0.05;
                    }
                    if (turnRight) {
                        this.el.object3D.rotation.y -= 0.05;
                    }

                    // Suporte a analógico caso exista
                    if (Math.abs(activeGamepad.axes[0]) > 0.1) {
                        this.el.object3D.rotation.y -= activeGamepad.axes[0] * 0.05;
                    }
                    if (Math.abs(activeGamepad.axes[1]) > 0.1) {
                        this.moveVector.set(0, 0, activeGamepad.axes[1] * moveSpeed);
                        this.el.object3D.localToWorld(this.moveVector);
                        this.el.object3D.position.add(this.moveVector);
                    }
                }

                // Movimento por toque
                if (isMoving) {
                    this.moveVector.set(0, 0, -moveSpeed);
                    this.el.object3D.localToWorld(this.moveVector);
                    this.el.object3D.position.add(this.moveVector);
                }
            }
        });
    </script>

    <a-scene>
        <!-- Assets -->
        <a-assets>
            <a-asset-item id="modelo" src="./arquivo.stl"></a-asset-item>
        </a-assets>

        <!-- Ambiente -->
        <a-sky color="#ECECEC"></a-sky>
        <a-grid material="color: #666" position="0 0 0"></a-grid>

        <!-- Iluminação -->
        <a-light type="ambient" color="#fff" intensity="0.5"></a-light>
        <a-light type="directional" color="#fff" intensity="0.8" position="-1 1 1"></a-light>

        <!-- Câmera com controles -->
        <a-entity position="0 1.6 0" gamepad-controls>
            <a-camera look-controls wasd-controls="enabled: false">
                <a-cursor></a-cursor>
            </a-camera>
        </a-entity>

        <!-- Modelo STL -->
        <a-entity 
            stl-model="src: #modelo"
            scale="0.1 0.1 0.1"
            position="0 0 -3"
            material="color: #888; metalness: 0.3; roughness: 0.7">
        </a-entity>
    </a-scene>
</body>
</html>
