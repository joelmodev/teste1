<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Game Viewer</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #vr-button {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <button id="vr-button">Enter VR</button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/VRControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/effects/VREffect.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.min.js"></script>

    <script>
        let scene, camera, renderer, vrButton;
        let controller1, controller2;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();
        let vrControls;

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 5);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            vrButton = VRButton.createButton(renderer);
            document.body.appendChild(vrButton);

            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(1, 1, 1).normalize();
            scene.add(directionalLight);

            // Floor
            const floorGeometry = new THREE.PlaneGeometry(1000, 1000);
            const floorMaterial = new THREE.MeshPhongMaterial({ color: 0x999999, side: THREE.DoubleSide });
            const floorMesh = new THREE.Mesh(floorGeometry, floorMaterial);
            floorMesh.rotation.x = -Math.PI / 2;
            scene.add(floorMesh);

            // Grid helper
            const gridHelper = new THREE.GridHelper(1000, 100);
            scene.add(gridHelper);

            // Add some cubes for reference
            for (let i = 0; i < 20; i++) {
                const geometry = new THREE.BoxGeometry(2, 2, 2);
                const material = new THREE.MeshPhongMaterial({ color: Math.random() * 0xffffff });
                const cube = new THREE.Mesh(geometry, material);
                cube.position.set(
                    Math.random() * 100 - 50,
                    1,
                    Math.random() * 100 - 50
                );
                scene.add(cube);
            }

            // STL Model
            const loader = new THREE.STLLoader();
            loader.load('modelo.stl', (geometry) => {
                const material = new THREE.MeshPhongMaterial({ color: 0xffd700, specular: 0x111111, shininess: 200 });
                const model = new THREE.Mesh(geometry, material);
                
                geometry.computeBoundingBox();
                const center = new THREE.Vector3();
                geometry.boundingBox.getCenter(center);
                model.position.sub(center);
                
                const scale = 2 / geometry.boundingBox.getSize(new THREE.Vector3()).length();
                model.scale.set(scale, scale, scale);
                
                model.position.set(10, 1, 10);
                
                scene.add(model);
            });

            // VR Controllers
            controller1 = renderer.xr.getController(0);
            scene.add(controller1);

            controller2 = renderer.xr.getController(1);
            scene.add(controller2);

            // VR Controls
            vrControls = new THREE.VRControls(camera);

            window.addEventListener('resize', onWindowResize, false);

            animate();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function handleController(controller) {
            if (controller.userData.selectPressed) {
                moveForward = true;
            } else {
                moveForward = false;
            }

            // Use controller orientation for direction
            controller.getWorldDirection(direction);
            direction.y = 0;
            direction.normalize();
        }

        function animate() {
            renderer.setAnimationLoop(render);
        }

        function render() {
            const delta = 0.016; // Assume 60fps

            velocity.x -= velocity.x * 10.0 * delta;
            velocity.z -= velocity.z * 10.0 * delta;

            handleController(controller1);
            handleController(controller2);

            if (moveForward) {
                velocity.addScaledVector(direction, 400.0 * delta);
            }

            camera.position.addScaledVector(velocity, delta);

            // Update VR headset position and apply to camera.
            vrControls.update();

            renderer.render(scene, camera);
        }

        // WebXR Button
        class VRButton {
            static createButton(renderer) {
                const button = document.createElement('button');
                button.id = 'vr-button';
                button.textContent = 'Enter VR';

                function showEnterVR() {
                    let currentSession = null;

                    async function onSessionStarted(session) {
                        session.addEventListener('end', onSessionEnded);
                        await renderer.xr.setSession(session);
                        button.textContent = 'Exit VR';
                        currentSession = session;
                    }

                    function onSessionEnded() {
                        currentSession.removeEventListener('end', onSessionEnded);
                        button.textContent = 'Enter VR';
                        currentSession = null;
                    }

                    button.onclick = () => {
                        if (currentSession === null) {
                            const sessionInit = { optionalFeatures: ['local-floor', 'bounded-floor'] };
                            navigator.xr.requestSession('immersive-vr', sessionInit).then(onSessionStarted);
                        } else {
                            currentSession.end();
                        }
                    };
                }

                if ('xr' in navigator) {
                    navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
                        supported ? showEnterVR() : VRButton.showWebXRNotFound();
                    });
                } else {
                    const message = document.createElement('a');
                    message.href = 'https://immersiveweb.dev/';
                    message.innerHTML = 'WEBXR NOT SUPPORTED';
                    message.style.left = 'calc(50% - 90px)';
                    message.style.width = '180px';
                    message.style.textDecoration = 'none';
                    button.appendChild(message);
                }

                return button;
            }

            static showWebXRNotFound() {
                const message = document.createElement('a');
                message.href = 'https://immersiveweb.dev/';
                message.innerHTML = 'WEBXR NOT AVAILABLE';
                message.style.left = 'calc(50% - 90px)';
                message.style.width = '180px';
                message.style.textDecoration = 'none';

                const button = document.getElementById('vr-button');
                button.appendChild(message);
                button.disabled = true;
            }
        }

        init();
    </script>
</body>
</html>